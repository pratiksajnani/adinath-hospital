name: CI/CD

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # =============================================
    # QUALITY CHECKS
    # =============================================
    quality:
        name: üîç Quality Checks
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint || echo "::warning::Linting issues found"

            - name: Check formatting
              run: npm run format:check || echo "::warning::Formatting issues found"

    # =============================================
    # UNIT TESTS
    # =============================================
    test:
        name: üß™ Unit Tests
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run unit tests with coverage
              run: npm run coverage

            - name: Upload coverage
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: test-results/coverage/
                  retention-days: 7

    # =============================================
    # SECURITY SCAN
    # =============================================
    security:
        name: üîí Security Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Check for exposed credentials
              run: |
                  echo "üîç Scanning for exposed credentials..."
                  if grep -rE "password['\"]?\s*[:=]\s*['\"][^'\"]{4,}['\"]" README.md 2>/dev/null | head -5; then
                    echo "‚ö†Ô∏è Warning: Credentials may be exposed in README"
                  fi
                  echo "‚úÖ Security scan complete"

            - name: Run npm audit
              run: npm audit --audit-level=high || echo "::warning::Vulnerabilities found"

    # =============================================
    # E2E TESTS (on PR only to save resources)
    # =============================================
    e2e:
        name: üé≠ E2E Tests
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'
        needs: [test]
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright
              run: npx playwright install chromium --with-deps

            - name: Start server
              run: npx serve -p 8080 &

            - name: Wait for server
              run: sleep 3

            - name: Run E2E tests
              run: npm run test:e2e -- --project=chromium
              env:
                  BASE_URL: http://localhost:8080

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 7

    # =============================================
    # DEPLOY TO GITHUB PAGES
    # =============================================
    deploy:
        name: üöÄ Deploy
        runs-on: ubuntu-latest
        needs: [quality, test, security]
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        permissions:
            contents: read
            pages: write
            id-token: write
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - uses: actions/checkout@v4

            - uses: actions/configure-pages@v4

            - uses: actions/upload-pages-artifact@v3
              with:
                  path: '.'

            - id: deployment
              uses: actions/deploy-pages@v4

            - name: Deployment summary
              run: |
                  echo "‚úÖ Deployed to: ${{ steps.deployment.outputs.page_url }}"
